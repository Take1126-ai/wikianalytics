# Wikipedia 概念マップ可視化プロジェクト
(生成AIにてREADME作成)

## 概要
本プロジェクトは、Wikipedia日本語版の記事データを用いて、記事（概念）間の関係性をインタラクティブなマップとして可視化することを目的としています。記事間のリンク関係とカテゴリ階層を利用してグラフを構築し、力指向レイアウトアルゴリズムによってノードの配置を決定することで、直感的で理解しやすい概念マップを生成します。

## 技術スタック
*   **プログラミング言語:** Python 3.12+
*   **パッケージ管理:** `uv`
*   **数値計算:** `numpy`
*   **グラフ処理:** `networkx`
*   **データ処理:** `lxml`
*   **インタラクティブ可視化:** `plotly`
*   **静的画像生成:** `matplotlib`, `japanize-matplotlib`

## セットアップ方法
1.  **Pythonのインストール:** Python 3.12以上がインストールされていることを確認してください。
2.  **`uv`のインストール:** `pip install uv` 等で`uv`をインストールします。
3.  **依存パッケージのインストール:** プロジェクトのルートディレクトリで以下のコマンドを実行します。
    ```bash
    uv sync
    ```
4.  **Wikipediaダンプデータの準備:** [Wikipediaの公式ダンプサイト](https://dumps.wikimedia.org/jawiki/latest/)から`jawiki-latest-pages-articles.xml.bz2`をダウンロードし、解凍して`files/jawiki-latest-pages-articles.xml`として配置します。このファイルは、テストデータを作成する場合や、フルデータセットで解析を実行する場合に必要です。

## 実行方法

アプリケーションの実行は、すべてルートディレクトリの `run.py` スクリプトで行います。

### 設定

実行する前に、`src/config.py` ファイル内のパラメータを調整することで、挙動を細かく制御できます。

*   `PAGE_LIMIT_FOR_TEST`: テストデータを作成する際のページ数を指定します。
*   `TITLES_TO_VISUALIZE`: 可視化したい記事のタイトルをリストで指定します。空リストの場合、`MIN_LINKS_FOR_VISUALIZATION` の設定が使われます。
*   `MIN_LINKS_FOR_VISUALIZATION`: `TITLES_TO_VISUALIZE` が空の場合に、可視化対象とするノードの最小リンク（接続）数を指定します。
*   その他、シミュレーションの物理パラメータやファイルパスなどもこのファイルで管理されています。

### 実行例

#### 基本的な使い方

*   **テストモードで全パイプラインを実行:**
    ```bash
    uv run run.py --test
    ```
    小規模なテストデータを作成し、それを使ってグラフ抽出から可視化まで一通り実行します。

*   **フルデータセットで全パイプラインを実行:**
    ```bash
    uv run run.py
    ```
    `files/jawiki-latest-pages-articles.xml` 全体を対象として処理を実行します。
    **注意:** この処理は非常に時間がかかり、大量のメモリを消費する可能性があります。

#### 特定のステップのみを実行

`--skip-*`系のフラグを組み合わせて、特定の処理のみを実行できます。

*   **グラフ抽出だけを実行したい場合:**
    ```bash
    uv run run.py --test --skip-create-test-data --skip-simulation --skip-visualization
    ```

*   **既存のデータを使って可視化だけを再実行したい場合:**
    ```bash
    uv run run.py --test --skip-create-test-data --skip-graph-extraction --skip-simulation
    ```

### 実行オプション（スキップフラグ）

*   `--skip-create-test-data`: テストデータXMLの作成をスキップします。
*   `--skip-graph-extraction`: グラフデータの抽出をスキップします。
*   `--skip-simulation`: 物理シミュレーションをスキップします。
*   `--skip-visualization`: 可視化ファイルの生成をスキップします。

## 設計概要

### アーキテクチャ
本システムは、責務ごとに分割された以下のモジュールで構成されています。

1.  **設定 (`src/config.py`):** シミュレーションパラメータ、ファイルパス、可視化対象の指定など、アプリケーション全体の設定値を一元管理します。
2.  **実行エンジン (`run.py`):** コマンドライン引数を解釈し、他のモジュールを呼び出してデータ処理と可視化のパイプライン全体を制御します。
3.  **データ作成 (`src/create_data.py`):** Wikipediaの巨大なXMLダンプから、指定ページ数の小規模なXMLファイルを生成するユーティリティです。
4.  **グラフ抽出 (`src/graph_extractor.py`):** XMLデータから、記事とカテゴリのグラフ構造と深さデータを抽出し、JSONファイルとして保存します。
5.  **可視化・シミュレーション (`src/visualize.py`):** グラフデータに基づき、力指向アルゴリズムによるシミュレーションを実行して各ノードの座標を計算し、`plotly`でインタラクティブなHTMLを、`matplotlib`で静的なPNG画像をそれぞれ出力します。

### データフロー
`run.py` が以下のフロー全体を管理します。

```
[Wikipedia XML] -> (1. create_data) -> [小規模XML]
↓
(2. graph_extractor) -> [グラフ.json & 深さ.json]
↓
(3. visualize.run_simulation) -> [シミュレーション結果.npy]
↓
(4. visualize.visualize_concepts) -> [可視化.html & 可視化.png]
```

### シミュレーションの改善点
*   **パフォーマンス改善 (ベクトル化):**
    *   力計算、初期粒子配置、および境界条件におけるPythonの `for` ループをNumPyのベクトル化された操作に置き換えることで、大規模データ処理時のシミュレーション速度が大幅に向上しました。
*   **動的境界計算:** シミュレーション空間のサイズは、`config.py`で定義された`PACKING_DENSITY`（充填率）と`BOUNDARY_SCALE_FACTOR`（スケール係数）に基づき、可視化対象のノード数に応じて動的に計算されるようになりました。これにより、ノード数に関わらず適切な広さの空間でシミュレーションが実行されます。
*   **安定した力モデル:**
    *   **斥力:** 以前の急峻な `1/r^13` 型から、よりソフトな `1/r` 型（距離に反比例）に変更し、さらに `REPULSION_CUTOFF_FACTOR` で定義されるカットオフ距離を超えると力がゼロになるようにしました。これにより、粒子が遠く離れた場合に力が無限に発散するのを防ぎ、シミュレーションの安定性が向上しました。
    *   **引力:** 不安定性の原因となっていた指数関数型や距離に比例する型から、`weight_matrix`でスケーリングされた「距離に寄らない一定の力」に変更しました。これにより、シミュレーションの数値的な安定性が大幅に向上し、`nan`値の発生が解消されました。